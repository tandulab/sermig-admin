import{u as Q}from"./location71895.js";import{D as F}from"./datetime71895.js";import{l as H,m as W,p as z,q as X,o as L,s as b,c as C,i as N,_ as T,r as f,b as x,v as B,w as c,f as l,g as r,e as V,x as S,h as O,t as y,a as J,y as Y,F as Z,n as q,z as $}from"../index71895.js";import{u as ee}from"./attraction71895.js";import{u as te}from"./guide71895.js";import{u as oe,p as ae,e as P}from"./helpers71895.js";import{f as ne,a as le,b as M}from"./formatData71895.js";import{F as se}from"./vee-validate.esm71895.js";class k{static async fetchAll(t){const a=t.get("location_id");return t.delete("location_id"),(await H(`/admin/locations/${a}/orders`,t)).data}static async fetchAllReveliaOrders(t){return(await H("/admin/orders",t)).data}static async deleteOrder(t){return await W(`/admin/orders/${t.order_id}/events/${t.event_id}/cancel`)}static async downloadOrderPDF(t){return await z(`/admin/orders/${t.order_id}/events/${t.event_id}/download`)}static async downloadOrderCsv(t){const a=t.get("location_id");return await z(`/admin/locations/${a}/orders`,t)}static async downloadReveliaOrderCsv(t){return await z("/admin/orders",t)}}const K=X({id:"order",state:()=>({order:{},orders:[],response_orders:{},total_orders:Number,calendar:{},discount:{},response:{}}),getters:{allOrders:n=>n.response_orders.orders,responseOrders:n=>n.response_orders,getTotalOrders:n=>n.response_orders?n.response_orders.total:0,getCurrentOrder:n=>n.order,status:()=>[{name:"Attivo",value:"true"},{name:"Disattivo",value:"false"}],getCalendar:n=>n.calendar,getDiscount:n=>n.discount,paymentStatus:()=>[{id:"to_pay",name:"Da pagare"},{id:"payed",name:"Pagato"},{id:"free",name:"Gratuito"}],paymentStatusRevelia:()=>[{id:"pending_payment",name:"In attesa di pagamento"},{id:"paid",name:"Pagato"},{id:"not_paid",name:"Non pagato"},{id:"canceled",name:"Cancellato"}],paymentModeList:()=>[{label:"Digitale (POS)",id:"credit_card"},{label:"Digitale (Satispay)",id:"satispay"},{label:"Ecommerce",id:"ecommerce"},{label:"Contanti",id:"cash"},{label:"Bonifico",id:"credit_transfer"},{label:"Biglietto a data aperta (voucher)",id:"voucher"}],getDeleteResponse:n=>n.response},actions:{async fetchAllOrders(n){await k.fetchAll(n).then(t=>this.response_orders=t)},async fetchAllReveliaOrders(n){await k.fetchAllReveliaOrders(n).then(t=>this.response_orders=t)},async deleteOrder(n){await k.deleteOrder(n)},async downloadOrderPDF(n){await k.downloadOrderPDF(n).then(t=>{const a=new Blob([t.data],{type:"application/pdf"}),e=URL.createObjectURL(a);window.open(e,"_blank")})},async downloadOrderCsv(n){await k.downloadOrderCsv(n).then(t=>{const a=new Blob([t.data],{type:"text/csv;charset=utf-8"}),e=document.createElement("a");e.href=window.URL.createObjectURL(a);const p=F.local().toFormat("dd_MM_yyyy");e.download="Prenotazioni_"+p+".csv",e.click()})},async downloadReveliaOrderCsv(n){await k.downloadReveliaOrderCsv(n).then(t=>{const a=new Blob([t.data],{type:"text/csv;charset=utf-8"}),e=document.createElement("a");e.href=window.URL.createObjectURL(a);const p=F.local().toFormat("dd_MM_yyyy");e.download="Prenotazioni_"+p+".csv",e.click()})}}}),re={props:["revelia"],setup(n,t){L(()=>{w()});const a=b({}),e=Q(),p=ee(),g=K(),u=te(),d=b([{name:"In attesa di conferma",value:"added"},{name:"Confermato",value:"confirmed"},{name:"Non Confermato",value:"canceled"}]),m=C(()=>e.allLocations),i=C(()=>p.allAttractions),v=C(()=>g.paymentStatus),o=C(()=>g.paymentStatusRevelia),s=C(()=>u.responseGuides),w=function(){n.revelia?(!i.value||i.value.length==0?j():(a.value.attraction=i.value[0],D()),G()):m.value?(a.value.location=m.value[0],D()):U()},D=function(){const I=F.local(),E=I.minus({months:1}).startOf("month");a.value.date_from=E.toFormat("dd/LL/yyyy"),a.value.date_to=I.toFormat("dd/LL/yyyy"),a.value.status=null,a.value.code="",a.value.user="",a.value.name="",a.value.guide=null,a.value.guide_id=null,a.value.attraction_id=null,a.value.event_status=null,t.emit("onSubmit",a.value)},A=function(){w()},U=async function(){await e.fetchAllLocations()},j=async function(){await p.fetchAllAttractions()},G=async function(){await u.fetchAllGuides()};return N(m,()=>{a.value.location_id=m.value[0].id,a.value.location=m.value[0],D()}),N(i,()=>{a.value.attraction_id=i.value[0].id,a.value.attraction=i.value[0],D()}),{form:a,event_statuses:d,locations:m,attractions:i,statuses:v,statusesRevelia:o,responseGuides:s,resetForm:A}}},de={class:"formgrid grid px-0 align-items-center"},ie={class:"field col-3 flex flex-column"},ce=r("label",{for:"typology"},"Location",-1),ue={class:"field col-2"},me=r("label",{from:"date_from"},"Dal",-1),_e={class:"field col-2"},fe=r("label",{from:"date_to"},"Al",-1),ve={key:0,class:"field col-3 flex flex-column"},pe=r("label",{from:"status"},"Codice prenotazione",-1),ye={key:1,class:"field col-3 flex flex-column"},be=r("label",{from:"status"},"Acquirente",-1),he={key:2,class:"field col-2 flex flex-column"},ge=r("label",{from:"guide"},"Guida",-1),we={class:"flex align-items-center"},xe={class:"field col-2 flex flex-column"},De=r("label",{from:"status"},"Stato pagamento",-1),Oe={key:3,class:"field col-2 flex flex-column"},Ve=r("label",{from:"event_status"},"Stato evento",-1),Re={class:"flex col-12 justify-content-end pt-1"};function ke(n,t,a,e,p,g){const u=f("Dropdown"),d=f("Calendar"),m=f("InputText"),i=f("Button"),v=f("AccordionTab"),o=f("Accordion");return x(),B(o,{activeIndex:0},{default:c(()=>[l(v,{header:"FILTRI"},{default:c(()=>[r("div",de,[r("div",ie,[ce,a.revelia?(x(),B(u,{key:1,modelValue:e.form.attraction,"onUpdate:modelValue":t[1]||(t[1]=s=>e.form.attraction=s),options:e.attractions,optionLabel:"name"},null,8,["modelValue","options"])):(x(),B(u,{key:0,modelValue:e.form.location,"onUpdate:modelValue":t[0]||(t[0]=s=>e.form.location=s),options:e.locations,optionLabel:"name"},null,8,["modelValue","options"]))]),r("div",ue,[me,l(d,{inputId:"date_from",modelValue:e.form.date_from,"onUpdate:modelValue":t[2]||(t[2]=s=>e.form.date_from=s),dateFormat:"dd/mm/yy",manualInput:!1,placeholder:""},null,8,["modelValue"])]),r("div",_e,[fe,l(d,{inputId:"date_to",modelValue:e.form.date_to,"onUpdate:modelValue":t[3]||(t[3]=s=>e.form.date_to=s),dateFormat:"dd/mm/yy",manualInput:!1,placeholder:""},null,8,["modelValue"])]),a.revelia?S("",!0):(x(),V("div",ve,[pe,l(m,{type:"text",modelValue:e.form.code,"onUpdate:modelValue":t[4]||(t[4]=s=>e.form.code=s)},null,8,["modelValue"])])),a.revelia?S("",!0):(x(),V("div",ye,[be,l(m,{type:"text",modelValue:e.form.name,"onUpdate:modelValue":t[5]||(t[5]=s=>e.form.name=s)},null,8,["modelValue"])])),a.revelia?(x(),V("div",he,[ge,l(u,{id:"guide",modelValue:e.form.guide,"onUpdate:modelValue":t[6]||(t[6]=s=>e.form.guide=s),options:e.responseGuides.guides},{value:c(s=>{var w,D;return[O(y((w=s.value)==null?void 0:w.first_name)+" "+y((D=s.value)==null?void 0:D.last_name),1)]}),option:c(s=>[r("div",we,[r("div",null,y(s.option.first_name)+" "+y(s.option.last_name),1)])]),_:1},8,["modelValue","options"])])):S("",!0),r("div",xe,[De,l(u,{id:"status",modelValue:e.form.status,"onUpdate:modelValue":t[7]||(t[7]=s=>e.form.status=s),options:a.revelia?e.statusesRevelia:e.statuses,optionLabel:"name",optionValue:"id",placeholder:""},null,8,["modelValue","options"])]),a.revelia?(x(),V("div",Oe,[Ve,l(u,{id:"event_status",modelValue:e.form.event_status,"onUpdate:modelValue":t[8]||(t[8]=s=>e.form.event_status=s),options:e.event_statuses,optionLabel:"name",optionValue:"value"},null,8,["modelValue","options"])])):S("",!0)]),r("div",Re,[l(i,{label:"Ricerca",class:"mr-2",onClick:t[9]||(t[9]=s=>n.$emit("onSubmit",e.form))}),l(i,{label:"Annulla",class:"p-button-outlined",onClick:t[10]||(t[10]=s=>e.resetForm())})])]),_:1})]),_:1})}const Ce=T(re,[["render",ke]]),Se={props:["filters"],setup(n,t){L(()=>{v.value=!0,o.value={first:0,rows:d.value.rows,sortField:null,sortOrder:null},o.value.page=0});const a=K(),{showLoader:e,hideLoader:p}=oe(),g=C(()=>a.responseOrders),u=J(),d=b(),m=b(),i=b(),v=b(!0),o=b(),s=b(0),w=b([]);function D(){v.value=!0,setTimeout(()=>{U()},Math.random()*1e3+250)}const A=function(_){Object.entries(n.filters).forEach(([h,R])=>{R&&((h=="date_from"||h=="date_to")&&R?_.set(h,M(R)):h=="location"?_.set("location_id",R.id):h=="code"?_.set("name",R):_.set(h,R))}),_.delete("guide"),_.set("page",o.value.page+1),_.set("per_page",o.value.rows)},U=async function(){const _=new Map;A(_),await a.fetchAllOrders(_).then(()=>{v.value=!1}).catch(h=>{v.value=!1,P(u,h)})};return{dt:d,responseOrders:g,loading:v,totalRecords:s,lazyParams:o,currentOrder:m,op:i,expandedRows:w,loadLazyData:D,toggle:_=>{i.value.toggle(_)},openDialog:function(_){const h={course_name:_.course_name,start_at:_.start_at};t.emit("updateFilters",h)},onPage:_=>{o.value=_,D()},openPDF:function(_){window.open(_,"_blank")},downloadCsv:async function(){const _=new Map;A(_),_.set("format","csv"),e(),await a.downloadOrderCsv(_).then(()=>{p()}).catch(h=>{p(),P(u,h)})},formatDataAndHourFromUnixTimestamps:ne,formatPrettyDate:le,prettyPaymentStatus:ae}}};const Fe={class:"flex justify-content-end mt-4 mb-3"},Ae={class:"order-table"},Be=["href"],Le=["href"],Te={key:0},Ue=r("div",{class:"flex justify-content-center w-full"},"PDF",-1),Ie={class:"flex justify-content-center"},ze={class:"flex justify-content-end"},Pe={class:"col-4 pl-6"};function Me(n,t,a,e,p,g){const u=f("Button"),d=f("Column"),m=f("Badge"),i=f("DataTable"),v=Y("tooltip");return x(),V(Z,null,[r("div",Fe,[l(u,{label:"CSV Prenotazioni",icon:"pi pi-download",rounded:"",outlined:"",onClick:t[0]||(t[0]=o=>e.downloadCsv())})]),r("div",Ae,[l(i,{value:e.responseOrders.orders,totalRecords:e.responseOrders.total,lazy:!0,paginator:!0,rows:30,ref:"dt",loading:e.loading,stripedRows:"",onPage:t[1]||(t[1]=o=>e.onPage(o)),expandedRows:e.expandedRows,"onUpdate:expandedRows":t[2]||(t[2]=o=>e.expandedRows=o)},{empty:c(()=>[O(" Nessuna prenotazione trovata. ")]),expansion:c(o=>[l(i,{value:o.data.order_items[0].tickets,class:"m-4 mx-4"},{empty:c(()=>[O(" Nessuna prenotazione trovata. ")]),footer:c(()=>[r("div",ze,[r("div",Pe,"Totale: € "+y((+o.data.total).toFixed(2)),1)])]),default:c(()=>[l(d,{header:"Tipo biglietto"},{body:c(({data:s})=>[l(m,{value:s.name,class:q([s.name,"px-3 border-round-lg"])},null,8,["value","class"])]),_:1}),l(d,{header:"Orario visita"},{body:c(()=>[O(y(o.data.order_items[0].time_slot.start_at),1)]),_:2},1024),l(d,{header:"Quantità"},{body:c(({data:s})=>[O(y(s.quantity),1)]),_:1}),l(d,{header:"Prezzo"},{body:c(({data:s})=>[O(" € "+y((+s.price).toFixed(2)),1)]),_:1}),l(d,{field:"tickets_url"},{header:c(()=>[Ue]),body:c(({data:s})=>[r("div",Ie,[$(l(u,{link:"",icon:"pi pi-print",href:s.tickets_url,target:"_blank",style:{color:"var(--surface-400)"},text:"",rounded:"",onClick:w=>e.openPDF(o.data.tickets_url)},null,8,["href","onClick"]),[[v,"Stampa",void 0,{top:!0}]])])]),_:2},1024)]),_:2},1032,["value"])]),default:c(()=>[l(d,{header:"Codice prenotazione",field:"reservation_number",ref:"reservation_number"},null,512),l(d,{header:"Effettuata da",field:"created_by",ref:"created_by"},{body:c(({data:o})=>[O(y(o.user_name)+" "+y(o.user_surname),1)]),_:1},512),l(d,{header:"Email",field:"user_email",ref:"user_email"},{body:c(({data:o})=>[r("a",{href:"https://mail.google.com/mail/?view=cm&fs=1&tf=1&to="+o.user_email,target:"_blank"},y(o.user_email),9,Be)]),_:1},512),l(d,{header:"Telefono",field:"user_phone"},{body:c(({data:o})=>[r("a",{href:"https://api.whatsapp.com/send?phone="+o.user_phone,target:"_blank"},y(o.user_phone),9,Le)]),_:1}),l(d,{header:"Data prenotazione",field:"created_at",ref:"created_at"},{body:c(({data:o})=>{var s,w;return[O(y(e.formatPrettyDate((w=(s=o.order_items[0])==null?void 0:s.time_slot)==null?void 0:w.date)),1)]}),_:1},512),l(d,{header:"Data ordine",field:"created_at",ref:"created_at"},{body:c(({data:o})=>[O(y(e.formatDataAndHourFromUnixTimestamps(o.created_at)),1)]),_:1},512),l(d,{header:"Stato"},{body:c(({data:o})=>[o.status?(x(),V("div",Te,[l(m,{value:e.prettyPaymentStatus(o.status),class:q([o.status,"px-3 border-round-lg"])},null,8,["value","class"])])):S("",!0)]),_:1}),l(d,{expander:"",style:{width:"5rem"}})]),_:1},8,["value","totalRecords","loading","expandedRows"])])],64)}const je=T(Se,[["render",Me]]),Ge={props:["location"],setup(n,t){L(()=>{e.value.start_date=F.local().startOf("day").toFormat("dd/MM/yyyy"),e.value.end_date=F.local().endOf("day").toFormat("dd/MM/yyyy"),e.value.created_at="true",e.value.start_hour="00:00",e.value.end_hour="23:59"});const a=J(),e=b({}),p=Q(),g=function(){let m=M(e.value.start_date)+" "+e.value.start_hour,i=M(e.value.end_date)+" "+e.value.end_hour;const v={from:m,to:i,location_id:n.location.id,location_permalink:n.location.permalink,created_at:e.value.created_at};u(v)},u=async function(m){await p.downloadReport(m).then(()=>{t.emit("onSubmit")}).catch(i=>{P(a,i)})};return{form:e,onSubmit:g,setDefaultIfBlank:function(){(!e.value.start_hour||e.value.start_hour=="")&&(e.value.start_hour="00:00"),(!e.value.end_hour||e.value.end_hour=="")&&(e.value.end_hour="23:59")}}},components:{Form:se}},Ee={class:"formgrid grid mt-3"},He={class:"field col-6 flex flex-column"},Ne=r("label",{from:"start_date"},"Dal",-1),qe=r("label",{from:"start_hour",class:"mt-3"},"Dalle",-1),Qe={class:"field col-6 flex flex-column"},Je=r("label",{from:"end_date"},"Al",-1),Ke=r("label",{from:"end_hour",class:"mt-3"},"Alle",-1),We={class:"flex flex-wrap gap-3 mt-3"},Xe={class:"flex align-items-center"},Ye=r("label",{for:"vendite",class:"ml-2"},"Report vendite",-1),Ze={class:"flex align-items-center"},$e=r("label",{for:"prenotazioni",class:"ml-2"},"Report visite",-1),et={class:"flex align-items-center justify-content-end mt-6"};function tt(n,t,a,e,p,g){const u=f("Calendar"),d=f("InputMask"),m=f("RadioButton"),i=f("Button"),v=f("Form");return x(),B(v,{onSubmit:e.onSubmit},{default:c(()=>[r("div",Ee,[r("div",He,[Ne,l(u,{inputId:"start_date",modelValue:e.form.start_date,"onUpdate:modelValue":t[0]||(t[0]=o=>e.form.start_date=o),dateFormat:"dd/mm/yy",manualInput:!0},null,8,["modelValue"]),qe,l(d,{id:"start_hour",modelValue:e.form.start_hour,"onUpdate:modelValue":t[1]||(t[1]=o=>e.form.start_hour=o),mask:"99:99",placeholder:"HH:mm",onBlur:t[2]||(t[2]=o=>e.setDefaultIfBlank())},null,8,["modelValue"])]),r("div",Qe,[Je,l(u,{inputId:"end_date",modelValue:e.form.end_date,"onUpdate:modelValue":t[3]||(t[3]=o=>e.form.end_date=o),dateFormat:"dd/mm/yy",manualInput:!0},null,8,["modelValue"]),Ke,l(d,{id:"end_hour",modelValue:e.form.end_hour,"onUpdate:modelValue":t[4]||(t[4]=o=>e.form.end_hour=o),mask:"99:99",placeholder:"HH:mm",onBlur:t[5]||(t[5]=o=>e.setDefaultIfBlank())},null,8,["modelValue"])])]),r("div",We,[r("div",Xe,[l(m,{modelValue:e.form.created_at,"onUpdate:modelValue":t[6]||(t[6]=o=>e.form.created_at=o),inputId:"vendite",name:"vendite",value:"true"},null,8,["modelValue"]),Ye]),r("div",Ze,[l(m,{modelValue:e.form.created_at,"onUpdate:modelValue":t[7]||(t[7]=o=>e.form.created_at=o),inputId:"prenotazioni",name:"prenotazioni",value:"false"},null,8,["modelValue"]),$e])]),r("div",et,[l(i,{label:"Annulla",text:"",onClick:t[8]||(t[8]=o=>n.$emit("onSubmit"))}),l(i,{label:"Scarica",type:"submit"})])]),_:1},8,["onSubmit"])}const ot=T(Ge,[["render",tt]]),at={setup(){L(()=>{});const n=b({}),t=b(),a=b(!1),e=b(!1);return{form:n,orderTable:t,isRevelia:a,visibleDialog:e,filterTable:function(u){n.value=u,t.value.loadLazyData()},onCloseReportDialog:function(){e.value=!1}}},components:{OrderFilter:Ce,OrderTable:je,SalesReportsDialog:ot}},nt={class:"flex justify-content-between align-items-center"},lt=r("h1",null,"Prenotazioni e incassi",-1);function st(n,t,a,e,p,g){const u=f("Button"),d=f("SalesReportsDialog"),m=f("Dialog"),i=f("OrderFilter"),v=f("OrderTable");return x(),V("div",null,[r("div",nt,[lt,l(u,{label:"Report",link:"",class:"m-0 p-0",icon:"pi pi-download",onClick:t[0]||(t[0]=o=>e.visibleDialog=!0)}),l(m,{visible:e.visibleDialog,"onUpdate:visible":t[2]||(t[2]=o=>e.visibleDialog=o),modal:"",header:"Report",style:{width:"35rem"}},{default:c(()=>[l(d,{onOnSubmit:t[1]||(t[1]=o=>e.onCloseReportDialog()),location:e.form.location},null,8,["location"])]),_:1},8,["visible"])]),l(i,{onOnSubmit:t[3]||(t[3]=o=>e.filterTable(o)),revelia:e.isRevelia},null,8,["revelia"]),l(v,{filters:e.form,ref:"orderTable"},null,8,["filters"])])}const pt=T(at,[["render",st]]);export{pt as default};
